const throttle=(e,t)=>{var a=!0,s=null;return function n(){var o=this;a?(a=!1,setTimeout(function(){a=!0,s&&n.apply(o)},t),s?(e.apply(this,s),s=null):e.apply(this,arguments)):s=arguments}};var keys=document.getElementsByClassName("key"),touchKeys=[],bottomKeys=touchKeys;const compileKey=e=>{let t=e.previousElementSibling,a=e.nextElementSibling;return{top:e.offsetTop,bottom:e.offsetTop+e.offsetHeight,left:e.offsetLeft,right:e.offsetLeft+e.offsetWidth,kflag:parseInt(e.dataset.kflag)+(parseInt(e.dataset.air)?32:0),prevKeyRef:t,nextKeyRef:a,ref:e}},isInside=(e,t,a)=>a.left<=e&&e<a.right&&a.top<=t&&t<a.bottom,compileKeys=()=>{keys=document.getElementsByClassName("key"),touchKeys=[];for(var e,t=0;t<keys.length;t++){let a=compileKey(keys[t]);touchKeys.push(a)}},getKey=(e,t)=>{for(var a=0;a<touchKeys.length;a++)if(isInside(e,t,touchKeys[a]))return touchKeys[a];return null};var lastState=[0,0,0,0,];function updateTouches(e){try{e.preventDefault();var t=[0,0,0,0,];throttledRequestFullscreen();for(var a=0;a<e.touches.length;a++){let s=e.touches[a],n=s.clientX,o=s.clientY,r=getKey(n,o);r&&setKey(t,r.kflag)}for(var a=0;a<touchKeys.length;a++){let l=touchKeys[a],c=l.kflag;t[c]!==lastState[c]&&(t[c]?l.ref.setAttribute("data-active",""):l.ref.removeAttribute("data-active"))}t!==lastState&&throttledSendKeys(t),lastState=t}catch(u){alert(u)}}const throttledUpdateTouches=throttle(updateTouches,10),setKey=(e,t)=>{var a=t;e[a]&&a++,e[a]=1},sendKeys=e=>{wsConnected&&ws.send("b"+e.join(""))},throttledSendKeys=throttle(sendKeys,10);var ws=null,wsTimeout=0,wsConnected=!1;const wsConnect=()=>{(ws=new WebSocket("ws://"+location.host+"/ws")).binaryType="arraybuffer",ws.onopen=()=>{ws.send("alive?")},ws.onmessage=e=>{e.data.byteLength?updateLed(e.data):"alive"==e.data&&(wsTimeout=0,wsConnected=!0)}},wsWatch=()=>{if(wsTimeout++>2){wsTimeout=0,ws.close(),wsConnected=!1,wsConnect();return}wsConnected&&ws.send("alive?")};var canvas=document.getElementById("canvas"),canvasCtx=canvas.getContext("2d"),canvasData=canvasCtx.getImageData(0,0,5,1);const setupLed=()=>{for(var e=0;e<5;e++)canvasData.data[4*e+3]=255};setupLed();const updateLed=e=>{let t=new Uint8Array(e);for(var a=0;a<4;a++)canvasData.data[4*a]=t[(3-a)*3+1],canvasData.data[4*a+1]=t[(3-a)*3+2],canvasData.data[4*a+2]=t[(3-a)*3+0];canvasData.data[128]=t[94],canvasData.data[129]=t[95],canvasData.data[130]=t[93],canvasCtx.putImageData(canvasData,0,0)},fs=document.getElementById("fullscreen"),requestFullscreen=()=>{!document.fullscreenElement&&screen.height<=1024&&(fs.requestFullscreen?fs.requestFullscreen():fs.mozRequestFullScreen?fs.mozRequestFullScreen():fs.webkitRequestFullScreen&&fs.webkitRequestFullScreen())},throttledRequestFullscreen=throttle(requestFullscreen,3e3),cnt=document.getElementById("main");cnt.addEventListener("touchstart",updateTouches),cnt.addEventListener("touchmove",updateTouches),cnt.addEventListener("touchend",updateTouches);const readConfig=e=>{var t="";e.invert&&(t+=".container, .air-container {flex-flow: column-reverse nowrap;} ");var a=e.bgColor||"rbga(0, 0, 0, 0.9)";e.bgImage?t+=`#fullscreen {background: ${a} url("${e.bgImage}") fixed center / cover!important; background-repeat: no-repeat;} `:t+=`#fullscreen {background: ${a};} `,"number"==typeof e.ledOpacity&&(0===e.ledOpacity?t+="#canvas {display: none} ":t+=`#canvas {opacity: ${e.ledOpacity}} `),"string"==typeof e.keyColor&&(t+=`.key[data-active] {background-color: ${e.keyColor};} `),"string"==typeof e.keyBorderColor&&(t+=`.key {border: 1px solid ${e.keyBorderColor};} `),e.keyColorFade&&"number"==typeof e.keyColorFade&&(t+=`.key:not([data-active]) {transition: background ${e.keyColorFade}ms ease-out;} `),"number"==typeof e.keyHeight&&(0===e.keyHeight?t+=".touch-container {display: none;} ":t+=`.touch-container {flex: ${e.keyHeight};} `);var s=document.createElement("style");s.innerHTML=t,document.head.appendChild(s)},initialize=()=>{readConfig(config),compileKeys(),wsConnect(),setInterval(wsWatch,1e3)};initialize(),window.onresize=compileKeys;